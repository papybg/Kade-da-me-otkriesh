<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Къде да ме откриеш?</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --error-color: #dc3545;
            --slot-highlight: gold;
        }
        * {
            box-sizing: border-box;
        }
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background-color: #2c3e50;
            color: white;
            touch-action: manipulation;
        }
        .hidden { display: none !important; }
        .visible { display: flex !important; }
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 15px;
            background-color: #1a2a3a;
        }
        #startScreen {
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .title {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 20px;
        }
        #portalContainer {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 1200px;
            margin-top: 20px;
        }
        .portal {
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .portal:hover {
            transform: scale(1.05);
        }
        .portal img {
            width: clamp(150px, 20vw, 250px);
            height: clamp(100px, 15vw, 140px);
            object-fit: cover;
            border-radius: 15px;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        .portal-name {
            font-size: clamp(1.2rem, 2vw, 1.8rem);
            font-weight: bold;
            margin-top: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }
        #gameScreen {
            padding: 10px;
        }
        .game-header {
            position: relative;
            text-align: center;
            padding: 10px 0;
            z-index: 10;
        }
        .top-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            width: 45px;
            height: 45px;
            font-size: 1.5rem;
            border-radius: 50%;
            border: 2px solid white;
            color: white;
            background-color: rgba(0, 0, 0, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #gameTitle {
            font-size: clamp(1.5rem, 3vw, 2.5rem);
            margin: 0;
        }
        #gameMessage {
            font-size: clamp(1rem, 2vw, 1.2rem);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 20px;
            border-radius: 50px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            color: #333;
            display: inline-block;
            margin-top: 8px;
            font-weight: bold;
        }
        #feedbackMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(4rem, 12vw, 8rem);
            font-family: 'Comic Sans MS', cursive, sans-serif;
            font-weight: bold;
            z-index: 2000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        #feedbackMessage.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }
        #feedbackMessage.correct {
            color: var(--success-color);
            text-shadow: 3px 3px 5px rgba(0,0,0,0.5);
        }
        #feedbackMessage.wrong {
            color: var(--error-color);
            text-shadow: 3px 3px 5px rgba(0,0,0,0.5);
        }
        #dropZone {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            min-height: 0;
            position: relative;
        }
        #gameBoard {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 1400px;
            background-size: cover;
            background-position: center;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            overflow: hidden;
        }
        .slot {
            position: absolute;
            border-radius: 50%;
            border: 3px dashed transparent;
            background-color: transparent;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 4px black;
            z-index: 2;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .slot.active {
            border: 4px solid var(--slot-highlight);
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px var(--slot-highlight);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        .placed-image-container {
            position: absolute;
            transform: translate(-50%, -50%);
            z-index: 3;
            animation: pop-in 0.4s ease-out;
        }
        .placed-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            aspect-ratio: 1/1;
            border-radius: 10%;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        .fun-fact-btn {
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            animation: sparkle 1.5s infinite;
        }
        @keyframes sparkle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        @keyframes pop-in {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .game-footer {
            width: 100%;
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #startTurnContainer {
            margin-bottom: 10px;
        }
        .game-btn {
            padding: 10px 30px;
            font-size: clamp(1rem, 2vw, 1.2rem);
            margin: 5px 0;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 50px;
            background: linear-gradient(45deg, #FF512F, #DD2476);
            background-size: 200% auto;
            transition: all 0.4s ease;
            box-shadow: 0 5px 15px rgba(221, 36, 118, 0.4);
            font-weight: bold;
            letter-spacing: 1px;
        }
        .game-btn:hover {
            background-position: right center;
            transform: scale(1.05);
        }
        #choiceZoneContainer {
            width: 100%;
            max-width: 1400px;
            overflow-x: auto;
            padding: 10px 0;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }
        #choiceZone {
            display: flex;
            gap: 12px;
            padding: 0 15px;
            justify-content: center;
            min-width: min-content;
        }
        .choice-item {
            width: clamp(60px, 10vw, 80px);
            height: clamp(60px, 10vw, 80px);
            object-fit: contain;
            background-color: white;
            border: 3px solid white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }
        .choice-item:hover {
            transform: scale(1.1);
            border-color: var(--slot-highlight);
        }
        .choice-item.used {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }
        .win-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .win-message {
            font-size: clamp(3rem, 10vw, 5rem);
            color: white;
            text-shadow: 0 0 20px var(--slot-highlight);
            margin-bottom: 30px;
            animation: win-pulse 2s infinite;
        }
        @keyframes win-pulse {
            0%, 100% { transform: scale(1); text-shadow: 0 0 20px var(--slot-highlight); }
            50% { transform: scale(1.1); text-shadow: 0 0 40px var(--slot-highlight); }
        }
        #orientation-overlay {
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 9999;
        }
        .orientation-message {
            padding: 2rem;
        }
        /* Gemini Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: #2c3e50;
            padding: 2rem;
            border-radius: 1rem;
            border: 2px solid var(--slot-highlight);
            width: 90%;
            max-width: 600px;
            text-align: center;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
        #modal-title {
            margin-top: 0;
            color: var(--slot-highlight);
        }
        #modal-body {
            min-height: 100px;
            margin: 1.5rem 0;
            font-size: 1.2rem;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--slot-highlight);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Landscape режим: Показваме играта */
        @media (orientation: landscape) {
            #game-wrapper { display: block; }
            #orientation-overlay { display: none; }
        }

        /* Portrait режим: Скриваме играта и показваме съобщението */
        @media (orientation: portrait) {
            #game-wrapper { display: none; }
            #orientation-overlay { display: flex; }
            #portalContainer { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="startScreen" class="screen visible">
            <h1 class="title">Къде искаш да играеш?</h1>
            <div id="portalContainer"></div>
        </div>
        
        <div id="gameScreen" class="screen hidden">
            <div class="game-header">
                <button id="backToMenuBtn" class="top-btn">☰</button>
                <h1 id="gameTitle" class="title"></h1>
                <div id="gameMessage"></div>
            </div>
            
            <div id="dropZone">
                <div id="gameBoard"></div>
                <div id="feedbackMessage"></div>
            </div>
            
            <div class="game-footer">
                <div id="startTurnContainer">
                    <button id="startTurnBtn" class="game-btn">СТАРТ</button>
                </div>
                <div id="choiceZoneContainer">
                    <div id="choiceZone"></div>
                </div>
            </div>
            
            <div id="winScreen" class="win-screen hidden">
                <button id="winScreenMenuBtn" class="top-btn">☰</button>
                <div id="winMessage" class="win-message">БРАВО!</div>
                <button id="playAgainBtn" class="game-btn">Нова игра</button>
            </div>
        </div>
    </div>

    <div id="orientation-overlay" class="screen hidden">
        <div class="orientation-message">
            <h1>Моля, завъртете устройството си в хоризонтален (landscape) режим, за да играете.</h1>
        </div>
    </div>
    
    <!-- Gemini Modal -->
    <div id="gemini-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            <h2 id="modal-title">✨ Ето нещо интересно! ✨</h2>
            <div id="modal-body">
                <div id="modal-loader" class="loader hidden"></div>
                <p id="modal-text"></p>
            </div>
            <button id="modal-continue-btn" class="game-btn">Продължи</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ДЕФИНИРАНЕ НА ЕЛЕМЕНТИТЕ ---
        const gameWrapper = document.getElementById('game-wrapper');
        const orientationOverlay = document.getElementById('orientation-overlay');
        const startScreenEl = document.getElementById('startScreen');
        const portalContainerEl = document.getElementById('portalContainer');
        const gameScreenEl = document.getElementById('gameScreen');
        const gameBoardEl = document.getElementById('gameBoard');
        const choiceZoneEl = document.getElementById('choiceZone');
        const gameMessageEl = document.getElementById('gameMessage');
        const gameTitleEl = document.getElementById('gameTitle');
        const winScreenEl = document.getElementById('winScreen');
        const winMessageEl = document.getElementById('winMessage');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const startTurnBtn = document.getElementById('startTurnBtn');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const feedbackMessageEl = document.getElementById('feedbackMessage');
        const winScreenMenuBtn = document.getElementById('winScreenMenuBtn');
        const geminiModal = document.getElementById('gemini-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalContinueBtn = document.getElementById('modal-continue-btn');
        const modalLoader = document.getElementById('modal-loader');
        const modalText = document.getElementById('modal-text');

        // --- АУДИО СИСТЕМА с Tone.js ---
        let bravoSound, opitaiPakSound;
        let audioInitialized = false;

        function initializeAudio() {
            if (audioInitialized || typeof Tone === 'undefined') return;
            try {
                Tone.start();
                const silentOsc = new Tone.Oscillator().toDestination();
                silentOsc.start().stop("+0.1");
                bravoSound = new Tone.Synth({ oscillator: { type: 'sine' } }).toDestination();
                opitaiPakSound = new Tone.Synth({ oscillator: { type: 'square' } }).toDestination();
                audioInitialized = true;
                document.body.removeEventListener('click', initializeAudio);
                document.body.removeEventListener('touchstart', initializeAudio);
            } catch (e) {
                console.error("Грешка при инициализиране на аудиото:", e);
            }
        }
        
        // --- ПРОМЕНЛИВИ ЗА СЪСТОЯНИЕТО ---
        let allItems = [];
        let portalsData = [];
        let layoutsData = {};
        let currentPortalData = {};
        let currentLayoutId = null;
        let isTurnActive = false;
        let availableSlots = [];
        let activeSlotData = null;
        let totalSlots = 0;

        // --- ЗАРЕЖДАНЕ НА ДАННИТЕ ---
        async function loadGameData() {
            const baseURL = "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/";
            const themesResponse = await fetch(baseURL + 'themes.json');
            const themesData = await themesResponse.json();
            allItems = themesData.allItems.map(item => ({...item, image: baseURL + item.image }));
            const portalsResponse = await fetch(baseURL + 'portals.json');
            const portalsDataFromServer = await portalsResponse.json();
            portalsData = portalsDataFromServer.portals.map(portal => ({...portal, icon: baseURL + portal.icon}));
            for (const portal of portalsData) {
                for (const layoutId of portal.layouts) {
                    if (!layoutsData[layoutId]) {
                        const layoutResponse = await fetch(`${baseURL}assets/layouts/${layoutId}.json`);
                        const layoutJson = await layoutResponse.json();
                        layoutsData[layoutId] = {...layoutJson, background: baseURL + layoutJson.background};
                    }
                }
            }
        }

        // --- ИНИЦИАЛИЗИРАНЕ НА ПРИЛОЖЕНИЕТО ---
        async function initializeApp() {
            try {
                await loadGameData();
                renderPortals(portalsData);
                setupEventListeners();
            } catch (error) {
                console.error("Грешка при инициализация:", error);
                portalContainerEl.innerHTML = `<p style="color:red;">Грешка при зареждане на играта.</p>`;
            }
        }

        // --- РЕНДИРАНЕ НА ПОРТАЛИТЕ ---
        function renderPortals(portals) {
            portalContainerEl.innerHTML = '';
            portals.forEach(portal => {
                const portalEl = document.createElement('div');
                portalEl.className = 'portal';
                portalEl.innerHTML = `<img src="${portal.icon}" alt="${portal.name}"><div class="portal-name">${portal.name}</div>`;
                portalEl.addEventListener('click', () => startGame(portal));
                portalContainerEl.appendChild(portalEl);
            });
        }

        // --- СТАРТИРАНЕ НА ИГРАТА ---
        function startGame(portal) {
            currentPortalData = portal;
            startScreenEl.classList.remove('visible');
            startScreenEl.classList.add('hidden');
            gameScreenEl.classList.remove('hidden');
            gameScreenEl.classList.add('visible');
            gameTitleEl.textContent = portal.name;
            currentLayoutId = portal.layouts[0];
            loadLayout(currentLayoutId);
        }
        
        // --- ЗАРЕЖДАНЕ НА КОНКРЕТНО НИВО ---
        function loadLayout(layoutId) {
            winScreenEl.classList.add('hidden');
            const levelData = layoutsData[layoutId];
            if (!levelData) { console.error(`Нивото ${layoutId} не бе намерено`); return; }
            resetGameState();
            gameBoardEl.style.backgroundImage = `url('${levelData.background}')`;
            availableSlots = JSON.parse(JSON.stringify(levelData.slots));
            totalSlots = availableSlots.length;
            createSlots(availableSlots);
            const choicePool = generateChoicePool(levelData);
            renderChoiceZone(choicePool);
            gameMessageEl.textContent = "Натисни СТАРТ за да започнеш!";
            startTurnBtn.classList.remove('hidden');
        }

        // --- ГЕНЕРИРАНЕ НА ИЗБОРИТЕ ---
        function generateChoicePool(levelData) {
            const correctItems = new Map();
            levelData.slots.forEach(slot => {
                const possibleItems = allItems.filter(item => slot.index.includes(item.index));
                if (possibleItems.length > 0) {
                    const randomItem = possibleItems[Math.floor(Math.random() * possibleItems.length)];
                    if (!correctItems.has(randomItem.id)) correctItems.set(randomItem.id, randomItem);
                }
            });
            const correctItemsArray = Array.from(correctItems.values());
            const distractorCount = 8 - correctItemsArray.length;
            const possibleDistractors = allItems.filter(item => !correctItems.has(item.id));
            const shuffledDistractors = shuffleArray(possibleDistractors).slice(0, Math.max(0, distractorCount));
            return shuffleArray([...correctItemsArray, ...shuffledDistractors]);
        }

        // --- РЕНДИРАНЕ НА ЗОНА ЗА ИЗБОР ---
        function renderChoiceZone(choicePool) {
            choiceZoneEl.innerHTML = '';
            choicePool.forEach(item => {
                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.name;
                img.classList.add('choice-item');
                img.addEventListener('click', () => handleChoiceClick(item, img));
                choiceZoneEl.appendChild(img);
            });
        }

        // --- СЪЗДАВАНЕ НА СЛОТОВЕТЕ ---
        function createSlots(slots) {
            gameBoardEl.innerHTML = '';
            slots.forEach((slot, index) => {
                const slotEl = document.createElement('div');
                slotEl.className = 'slot';
                slotEl.style.width = slot.diameter;
                slotEl.style.height = slot.diameter;
                slotEl.style.top = slot.position.top;
                slotEl.style.left = slot.position.left;
                slotEl.dataset.originalIndex = index;
                gameBoardEl.appendChild(slotEl);
            });
        }

        // --- СТАРТИРАНЕ НА ХОД ---
        function startNewTurn() {
            isTurnActive = true;
            startTurnBtn.classList.add('hidden');
            activateNextSlot();
        }

        // --- АКТИВИРАНЕ НА СЛЕДВАЩ СЛОТ ---
        function activateNextSlot() {
            if (activeSlotData) {
                const prevSlot = document.querySelector(`.slot[data-original-index="${activeSlotData.originalIndex}"]`);
                if (prevSlot) prevSlot.classList.remove('active');
            }
            if (availableSlots.length > 0) {
                activeSlotData = { ...availableSlots[0], originalIndex: totalSlots - availableSlots.length };
                const activeSlotEl = document.querySelector(`.slot[data-original-index="${activeSlotData.originalIndex}"]`);
                if (activeSlotEl) {
                    activeSlotEl.classList.add('active');
                    gameMessageEl.textContent = `Какво ще има тук?`;
                }
            } else {
                showFeedback(true, "БРАВО!");
                if(bravoSound) bravoSound.triggerAttackRelease("C5", "0.5s");
                setTimeout(() => {
                    winMessageEl.textContent = "БРАВО, ДА ОПИТАМЕ ПАК!";
                    winScreenEl.classList.remove('hidden');
                }, 1500);
                activeSlotData = null;
            }
        }

        // --- ОБРАБОТКА НА ИЗБОРА ---
        function handleChoiceClick(chosenItem, chosenImgElement) {
            if (!isTurnActive || !activeSlotData || chosenImgElement.classList.contains('used')) return;
            const isValid = activeSlotData.index.includes(chosenItem.index);
            if (isValid) {
                showFeedback(true, "Браво!");
                if(bravoSound) bravoSound.triggerAttackRelease("C5", "0.5s");
                placeImageInSlot(chosenItem, activeSlotData);
                chosenImgElement.classList.add('used');
                availableSlots.shift();
                // Не активираме следващия слот веднага, чакаме потребителя
            } else {
                showFeedback(false, "Опитай пак!");
                if(opitaiPakSound) opitaiPakSound.triggerAttackRelease("C3", "0.5s");
                chosenImgElement.style.borderColor = 'red';
                setTimeout(() => { if (chosenImgElement) chosenImgElement.style.borderColor = 'white'; }, 500);
            }
        }
        
        // --- ПОКАЗВАНЕ НА ОБРАТНА ВРЪЗКА ---
        function showFeedback(isCorrect, message) {
            feedbackMessageEl.textContent = message;
            feedbackMessageEl.className = isCorrect ? 'correct' : 'wrong';
            feedbackMessageEl.classList.add('show');
            setTimeout(() => { feedbackMessageEl.classList.remove('show'); }, 1500);
        }

        // --- ПОСТАВЯНЕ НА КАРТИНКА В СЛОТ ---
        function placeImageInSlot(item, slotData) {
            const container = document.createElement('div');
            container.className = 'placed-image-container';
            container.style.width = slotData.diameter;
            container.style.height = slotData.diameter;
            container.style.top = slotData.position.top;
            container.style.left = slotData.position.left;

            const img = document.createElement('img');
            img.src = item.image;
            img.alt = item.name;
            img.classList.add('placed-image');
            
            const btn = document.createElement('button');
            btn.className = 'fun-fact-btn';
            btn.innerHTML = '✨';
            btn.onclick = () => getFunFact(item);

            container.appendChild(img);
            container.appendChild(btn);
            gameBoardEl.appendChild(container);
        }

        // --- GEMINI API ИНТЕГРАЦИЯ ---
        async function getFunFact(item) {
            modalText.innerHTML = '';
            modalLoader.classList.remove('hidden');
            geminiModal.classList.remove('hidden');

            const prompt = `Разкажи ми много кратка (1-2 изречения) и забавна история или интересен факт за ${item.name}, подходяща за 5-годишно дете.`;
            
            const apiKey = ""; // API ключът се предоставя автоматично от средата
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API грешка: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                modalText.textContent = text;
            } catch (error) {
                console.error("Грешка при извикване на Gemini API:", error);
                modalText.textContent = "О, не! В момента не мога да измисля история. Моля, опитай пак след малко.";
            } finally {
                modalLoader.classList.add('hidden');
            }
        }

        // --- НУЛИРАНЕ НА СЪСТОЯНИЕТО НА ИГРАТА ---
        function resetGameState() {
            isTurnActive = false;
            availableSlots = [];
            activeSlotData = null;
            totalSlots = 0;
            winScreenEl.classList.add('hidden');
            startTurnBtn.classList.remove('hidden');
        }

        // --- ВРЪЩАНЕ В ГЛАВНОТО МЕНЮ ---
        function showMenu() {
            gameScreenEl.classList.remove('visible');
            gameScreenEl.classList.add('hidden');
            winScreenEl.classList.add('hidden');
            startScreenEl.classList.remove('hidden');
            startScreenEl.classList.add('visible');
        }

        // --- НАСТРОЙКА НА СЛУШАТЕЛИТЕ ---
        function setupEventListeners() {
            startTurnBtn.addEventListener('click', startNewTurn);
            playAgainBtn.addEventListener('click', () => loadLayout(currentLayoutId));
            backToMenuBtn.addEventListener('click', showMenu);
            winScreenMenuBtn.addEventListener('click', showMenu);
            
            const closeModal = () => {
                geminiModal.classList.add('hidden');
                activateNextSlot(); // Продължаваме към следващия ход
            };
            modalCloseBtn.addEventListener('click', closeModal);
            modalContinueBtn.addEventListener('click', closeModal);

            document.body.addEventListener('click', initializeAudio, { once: true });
            document.body.addEventListener('touchstart', initializeAudio, { once: true });
        }

        // --- ПОМОЩНИ ФУНКЦИИ ---
        function shuffleArray(array) {
            const result = [...array];
            for (let i = result.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result;
        }

        // --- СТАРТИРАНЕ НА ПРИЛОЖЕНИЕТО ---
        initializeApp();
    });
    </script>
</body>
</html>

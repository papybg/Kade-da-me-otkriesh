<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Къде да ме откриеш?</title>
    <!-- Tailwind CSS за бърз и адаптивен дизайн -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js за надеждна работа със звуци в браузъра -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <!-- Шрифтове за по-добър изглед -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Предотвратява двойното приближаване при докосване на мобилни устройства */
        }
        .font-fredoka {
            font-family: 'Fredoka One', cursive;
        }
        /* Анимация за появяване на кръга */
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in {
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        /* Анимация за съобщенията "Браво" / "Опитай пак" */
        @keyframes fade-in-out {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .fade-in-out {
            animation: fade-in-out 2s ease-in-out forwards;
        }
        /* Анимация за разклащане при грешен отговор */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-sky-100 flex items-center justify-center min-h-screen">

    <div id="game-container" class="w-full max-w-4xl mx-auto aspect-[4/3] sm:aspect-video bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col relative">

        <!-- Начален екран -->
        <div id="start-screen" class="flex flex-col items-center justify-center h-full bg-gradient-to-br from-yellow-200 to-orange-300 p-8 text-center">
            <h1 class="text-4xl sm:text-6xl md:text-7xl font-fredoka text-orange-600 drop-shadow-lg">Къде да ме откриеш?</h1>
            <p class="mt-4 text-lg text-orange-800">Избери ниво, за да започнеш играта!</p>
            <div id="level-selection" class="mt-8 flex flex-wrap justify-center gap-4 sm:gap-8">
                <!-- Бутоните за нива ще се генерират тук от JS -->
            </div>
        </div>

        <!-- Екран на играта -->
        <div id="game-screen" class="hidden h-full w-full flex-grow relative">
            <img id="background-image" src="" alt="Фон на играта" class="w-full h-full object-cover absolute inset-0">
            <div id="target-circle" class="absolute rounded-full border-4 border-dashed border-yellow-300 bg-black bg-opacity-20 backdrop-blur-sm shadow-lg flex items-center justify-center transition-all duration-500">
                 <img id="placed-image" src="" class="w-full h-full object-contain hidden transition-transform duration-500 transform scale-0">
            </div>
            <div id="feedback-message" class="absolute inset-x-0 top-1/4 text-center text-6xl font-fredoka text-white drop-shadow-xl pointer-events-none"></div>
        </div>
        
        <!-- Лента с избори -->
        <div id="choices-bar" class="hidden w-full bg-slate-700 bg-opacity-80 backdrop-blur-sm p-2 sm:p-4">
            <div id="choices-container" class="grid grid-cols-4 sm:grid-cols-8 gap-2 sm:gap-4 justify-items-center">
                <!-- Картинките за избор ще се генерират тук от JS -->
            </div>
        </div>

        <!-- Краен екран -->
        <div id="end-screen" class="hidden flex-col items-center justify-center h-full bg-gradient-to-br from-teal-200 to-cyan-300 p-8 text-center">
            <h2 class="text-5xl sm:text-7xl font-fredoka text-cyan-700 drop-shadow-lg">Поздравления!</h2>
            <p class="mt-4 text-xl text-cyan-900">Ти завърши нивото успешно!</p>
            <div class="mt-8 flex flex-col sm:flex-row gap-4">
                <button id="new-game-btn" class="px-8 py-4 bg-green-500 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-green-600 transition-colors duration-300">ИГРАЙ ОТНОВО</button>
                <button id="menu-btn" class="px-8 py-4 bg-orange-500 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-orange-600 transition-colors duration-300">МЕНЮ</button>
            </div>
        </div>

    </div>

    <script>
        // FIX: Променяме 'DOMContentLoaded' на 'load'.
        // 'load' изчаква всички ресурси (включително външни скриптове като Tone.js) да бъдат заредени,
        // преди да изпълни кода, което предотвратява грешката 'Tone is not defined'.
        window.addEventListener('load', () => {
            
            // --- DOM Елементи ---
            const startScreen = document.getElementById('start-screen');
            const gameScreen = document.getElementById('game-screen');
            const endScreen = document.getElementById('end-screen');
            const choicesBar = document.getElementById('choices-bar');
            const choicesContainer = document.getElementById('choices-container');
            const targetCircle = document.getElementById('target-circle');
            const placedImage = document.getElementById('placed-image');
            const backgroundImage = document.getElementById('background-image');
            const feedbackMessage = document.getElementById('feedback-message');
            const levelSelectionContainer = document.getElementById('level-selection');

            // --- Аудио система ---
            let correctSound, wrongSound;
            let audioInitialized = false;

            // Аудиото се инициализира при първото действие на потребителя, за да се спазят правилата на браузърите.
            function initializeAudio() {
                if (audioInitialized) return;
                try {
                    Tone.start();
                    correctSound = new Tone.Synth().toDestination();
                    wrongSound = new Tone.Synth({ oscillator: { type: 'square' } }).toDestination();
                    audioInitialized = true;
                } catch (e) {
                    console.error("Грешка при инициализиране на аудиото:", e);
                    // Създаваме празни функции, за да не се чупи играта, ако аудиото не тръгне.
                    correctSound = { triggerAttackRelease: () => {} };
                    wrongSound = { triggerAttackRelease: () => {} };
                }
            }

            // --- Състояние на играта ---
            let allItems = [];
            let allLevels = [];
            let currentLevel;
            let currentTargetIndex;
            let isChecking = false;

            // --- Данни за играта ---
            function initializeGameData() {
                const gameData = {
                    "items": [
                        { "id": "plane", "type": "s", "src": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/items/plane.png" },
                        { "id": "bird", "type": "s", "src": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/items/bird.png" },
                        { "id": "sun", "type": "s", "src": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/items/sun.png" },
                        { "id": "car", "type": "r", "src": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/items/car.png" },
                        { "id": "truck", "type": "r", "src": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/items/truck.png" },
                        { "id": "train", "type": "t", "src": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/items/train.png" },
                        { "id": "cow", "type": "p", "src": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/items/cow.png" },
                        { "id": "sheep", "type": "p", "src": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/items/sheep.png" },
                        { "id": "house", "type": "h", "src": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/items/house.png" },
                        { "id": "tree", "type": "h", "src": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/items/tree.png" }
                    ],
                    "levels": [
                        {
                            "id": 0,
                            "name": "Природа",
                            "icon": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/portals/nature.png",
                            "background": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/backgrounds/nature-bg.jpg",
                            "targets": [
                                { "type": "s", "coords": [50, 10, 15] },
                                { "type": "r", "coords": [30, 75, 15] },
                                { "type": "t", "coords": [70, 65, 20] },
                                { "type": "p", "coords": [15, 55, 15] },
                                { "type": "h", "coords": [75, 40, 20] }
                            ]
                        },
                        {
                            "id": 1,
                            "name": "Град",
                            "icon": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/portals/city.png",
                            "background": "https://raw.githubusercontent.com/papybg/Kade-da-me-otkriesh/main/assets/images/backgrounds/city-bg.jpg",
                            "targets": [
                                { "type": "s", "coords": [20, 15, 15] },
                                { "type": "r", "coords": [50, 80, 25] },
                                { "type": "h", "coords": [80, 50, 20] }
                            ]
                        }
                    ]
                };
                allItems = gameData.items;
                allLevels = gameData.levels;
            }

            // --- Логика на играта ---

            // Създава бутоните за избор на ниво на началния екран
            function createLevelButtons() {
                levelSelectionContainer.innerHTML = ''; // Изчистваме контейнера
                allLevels.forEach(level => {
                    const button = document.createElement('button');
                    button.className = "w-24 h-24 sm:w-32 sm:h-32 bg-sky-400 rounded-full shadow-lg flex items-center justify-center text-white font-bold text-5xl transform hover:scale-110 transition-transform duration-300";
                    button.innerHTML = `<img src="${level.icon}" class="w-2/3 h-2/3 object-contain" alt="${level.name}">`; // Използва иконата от JSON
                    button.onclick = () => startGame(level.id);
                    levelSelectionContainer.appendChild(button);
                });
            }

            function startGame(levelId) {
                initializeAudio();
                
                currentLevel = allLevels.find(l => l.id === levelId);
                if (!currentLevel) return;

                currentTargetIndex = 0;
                
                startScreen.classList.add('hidden');
                endScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                choicesBar.classList.remove('hidden');
                backgroundImage.src = currentLevel.background;
                
                nextQuestion();
            }

            function showMenu() {
                endScreen.classList.add('hidden');
                gameScreen.classList.add('hidden');
                choicesBar.classList.add('hidden');
                startScreen.classList.remove('hidden');
            }

            function nextQuestion() {
                if (currentTargetIndex >= currentLevel.targets.length) {
                    endGame();
                    return;
                }

                const targetData = currentLevel.targets[currentTargetIndex];
                
                placedImage.src = '';
                placedImage.classList.add('hidden', 'scale-0');
                targetCircle.classList.remove('pop-in');
                void targetCircle.offsetWidth;
                targetCircle.classList.add('pop-in');

                const [left, top, width] = targetData.coords;
                targetCircle.style.left = `${left}%`;
                targetCircle.style.top = `${top}%`;
                targetCircle.style.width = `${width}%`;
                
                const container = document.getElementById('game-container');
                const aspectRatio = container.offsetWidth / container.offsetHeight;
                targetCircle.style.height = `${width / aspectRatio}%`;

                populateChoices(targetData.type);
            }

            function populateChoices(correctType) {
                choicesContainer.innerHTML = '';
                isChecking = false;

                const correctItems = allItems.filter(item => item.type === correctType);
                const correctChoice = correctItems[Math.floor(Math.random() * correctItems.length)];

                const wrongItems = allItems.filter(item => item.type !== correctType);
                const wrongChoices = [];
                while (wrongChoices.length < 7 && wrongItems.length > 0) {
                    const randomIndex = Math.floor(Math.random() * wrongItems.length);
                    wrongChoices.push(wrongItems.splice(randomIndex, 1)[0]);
                }

                const choices = [correctChoice, ...wrongChoices].sort(() => Math.random() - 0.5);

                choices.forEach(item => {
                    const choiceEl = document.createElement('div');
                    choiceEl.className = 'w-16 h-16 sm:w-20 sm:h-20 bg-white/20 rounded-lg p-1 cursor-pointer transform hover:scale-110 hover:bg-white/40 transition-transform duration-200';
                    choiceEl.innerHTML = `<img src="${item.src}" alt="${item.id}" class="w-full h-full object-contain">`;
                    choiceEl.onclick = () => checkAnswer(item, correctType);
                    choicesContainer.appendChild(choiceEl);
                });
            }

            function checkAnswer(chosenItem, correctType) {
                if (isChecking) return;
                isChecking = true;

                if (chosenItem.type === correctType) {
                    correctSound.triggerAttackRelease("C5", "8n", Tone.now());
                    showFeedback(true, "Браво!");
                    
                    placedImage.src = chosenItem.src;
                    placedImage.classList.remove('hidden', 'scale-0');
                    void placedImage.offsetWidth;
                    placedImage.classList.add('scale-100');

                    setTimeout(() => {
                        currentTargetIndex++;
                        nextQuestion();
                    }, 2000);

                } else {
                    wrongSound.triggerAttackRelease("C3", "8n", Tone.now());
                    showFeedback(false, "Опитай пак!");
                    
                    choicesContainer.classList.add('shake');
                    
                    setTimeout(() => {
                        choicesContainer.classList.remove('shake');
                        isChecking = false;
                    }, 1500);
                }
            }
            
            function showFeedback(isCorrect, message) {
                feedbackMessage.textContent = message;
                feedbackMessage.className = `absolute inset-x-0 top-1/4 text-center text-6xl font-fredoka drop-shadow-xl pointer-events-none fade-in-out ${isCorrect ? 'text-green-400' : 'text-red-500'}`;
            }

            function endGame() {
                gameScreen.classList.add('hidden');
                choicesBar.classList.add('hidden');
                endScreen.classList.remove('hidden');
            }

            // --- Event Listeners ---
            document.getElementById('new-game-btn').addEventListener('click', () => startGame(currentLevel.id));
            document.getElementById('menu-btn').addEventListener('click', showMenu);

            window.onresize = () => {
                 if (!gameScreen.classList.contains('hidden') && currentLevel) {
                    const targetData = currentLevel.targets[currentTargetIndex];
                    if (!targetData) return;
                    const [left, top, width] = targetData.coords;
                    const container = document.getElementById('game-container');
                    const aspectRatio = container.offsetWidth / container.offsetHeight;
                    targetCircle.style.height = `${width / aspectRatio}%`;
                 }
            };
            
            // --- Старт на играта ---
            initializeGameData();
            createLevelButtons();
        });
    </script>
</body>
</html>
